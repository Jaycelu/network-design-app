# 抓包功能设计文档

## 1. 功能概述

本功能旨在为网络工程师提供一个集成的抓包分析工具，允许用户通过选择网络接口进行数据包捕获，并将捕获的数据提交给AI进行网络问题分析。该功能将替换现有的报表分析模块，作为主界面四个核心模块之一。

## 2. 技术可行性分析

### 2.1 技术栈分析
- 应用基于Next.js 15 + TypeScript + Tailwind CSS + shadcn/ui
- 使用自定义server.ts作为后端服务
- 已集成Socket.IO用于实时通信
- 支持Electron桌面应用

### 2.2 抓包技术方案
由于在Windows平台上安装需要原生编译的抓包库存在技术挑战，我们采用以下方案：
- 使用现有的网络接口信息获取功能（基于systeminformation库）
- 实现模拟的抓包功能，提供实时统计数据
- 支持用户上传真实的pcap文件进行分析
- 在条件允许的环境中，可以集成真实的抓包库

### 2.3 Windows平台集成
考虑到原生依赖安装的复杂性，我们提供以下替代方案：
- 通过应用内提示引导用户安装npcap驱动（如果需要真实抓包）
- 提供pcap文件上传功能，用户可以使用外部工具捕获数据包后上传分析
- 实现完整的抓包数据模拟功能，满足基本演示需求

### 2.4 Windows平台驱动安装提示
为了确保用户能够正常使用抓包功能，应用需要检测并提示用户安装npcap驱动：
- 应用启动时检测系统是否已安装npcap驱动
- 如果未安装，弹出提示框引导用户下载安装
- 提供npcap官方下载链接
- 指导用户完成安装过程并重启应用
- 提供pcap文件上传作为替代方案

## 3. 用户界面设计

### 3.1 界面集成位置
替换现有的报表分析模块：
- 在主界面中，作为项目管理、设备管理、AI排错后的第四个核心模块
- 使用抓包分析相关图标标识（如网络数据包图标）
- 点击后进入独立的抓包分析界面

### 3.2 功能交互流程
1. 用户从主界面点击"抓包分析"模块
2. 系统列出所有可用网络接口
3. 用户选择目标网络接口
4. 用户点击"开始抓包"按钮
5. 系统开始捕获数据包，显示实时统计信息
6. 用户点击"停止抓包"按钮
7. 系统保存抓包数据为PCAP文件
8. 用户点击"提交AI分析"按钮
9. 系统将PCAP文件上传并提交给AI分析
10. 显示AI分析结果

### 3.3 界面组件设计
- 网络接口选择器：下拉列表显示所有可用接口
- 控制按钮：开始抓包、停止抓包、提交分析
- 实时统计面板：显示已捕获数据包数量、大小等
- 状态指示器：显示当前抓包状态
- AI分析结果显示区域
- 返回主界面按钮
- 驱动安装提示和下载链接（Windows平台）

## 4. AI分析接口设计

### 4.1 数据传输格式
- 将PCAP文件作为二进制文件上传
- 通过multipart/form-data格式传输
- 文件大小限制：50MB（可配置）

### 4.2 AI分析提示词设计
```text
你是一位专业的网络运维工程师，请根据提供的网络数据包捕获文件，分析其中可能存在的网络问题。

请提供以下内容的专业分析：

1. 异常流量检测：
   - 识别异常的流量模式
   - 检测潜在的DDoS攻击或端口扫描行为
   - 发现异常的协议使用

2. 性能问题分析：
   - 识别网络延迟较高的数据流
   - 检测重传率较高的连接
   - 分析带宽使用情况

3. 安全问题识别：
   - 检测潜在的安全威胁
   - 识别未加密的敏感数据传输
   - 发现异常的访问模式

4. 优化建议：
   - 提供网络性能优化建议
   - 给出安全加固措施
   - 提出网络架构改进建议

要求：
- 分析专业、深入、具体
- 提供可操作的解决方案
- 语言简洁明了
- 总字数控制在1000字以内
```

### 4.3 接口调用流程
1. 前端将PCAP文件上传到后端
2. 后端保存文件并解析基本信息
3. 后端调用AI分析接口
4. 将AI分析结果返回给前端显示

## 5. 技术实现方案

### 5.1 后端实现
1. 在server.ts中添加抓包相关API路由
2. 使用node_pcap库实现抓包功能
3. 实现PCAP文件上传和存储
4. 实现AI分析接口调用

### 5.2 前端实现
1. 在DeviceManagement组件中添加抓包子模块
2. 实现网络接口选择和状态显示
3. 实现抓包控制按钮和实时统计
4. 实现AI分析结果展示

### 5.3 安全和权限考虑
1. 抓包功能需要管理员权限运行
2. 限制PCAP文件访问权限
3. 对上传文件进行大小和类型验证
4. 实施适当的错误处理和日志记录

## 6. 实施步骤

### 6.1 环境准备
1. 安装npcap运行时库（Windows）
2. 安装libpcap开发包（Linux/macOS）
3. 安装node_pcap依赖库

### 6.2 后端开发
1. 创建抓包API路由
2. 实现网络接口枚举功能
3. 实现模拟数据包捕获功能
4. 实现PCAP文件上传接口
5. 实现AI分析接口调用
6. 实现数据包过滤功能（BPF语法支持）
7. 设计抓包记录数据库结构
8. 实现抓包任务调度系统
9. 设计AI分析模板管理系统
10. 实现系统环境检测功能（检测npcap驱动是否安装）
11. 为真实抓包功能预留扩展接口

### 6.3 前端开发
1. 创建独立的抓包分析模块组件
2. 实现主界面模块卡片替换（替换报表分析模块）
3. 实现网络接口选择UI
4. 实现抓包控制和状态显示
5. 实现AI分析结果展示界面
6. 添加必要的错误处理和用户提示
7. 实现数据包过滤器图形化构建器
8. 实现数据包可视化展示（流量图表、协议分布图等）
9. 实现历史抓包记录管理界面
10. 实现抓包任务调度管理界面
11. 实现AI分析模板配置界面
12. 实现Windows平台驱动安装检测和提示功能
13. 实现PCAP文件上传功能
14. 实现与后端API的真实交互

### 6.4 集成测试
1. 测试抓包功能在不同平台的兼容性
2. 验证AI分析结果的准确性
3. 测试大文件上传和处理性能
4. 验证权限和安全机制
5. 测试数据包过滤功能的正确性
6. 验证数据包可视化展示的准确性
7. 测试历史记录管理功能
8. 验证抓包任务调度功能
9. 测试AI分析模板功能

### 6.5 部署和文档
1. 编写用户使用文档
2. 提供安装和配置指南
3. 部署到生产环境
4. 监控系统运行状态
5. 提供API文档和开发指南
6. 在用户文档中详细说明Windows平台npcap驱动安装步骤
7. 测试应用在不同Windows版本上的兼容性

## 7. 风险和限制

### 7.1 技术风险
- 不同操作系统兼容性问题
- 网络接口权限访问限制
- 大文件处理性能问题
- 原生依赖库安装复杂性（特别是在Windows平台）

### 7.2 安全考虑
- 需要管理员权限运行
- PCAP文件可能包含敏感信息
- 网络接口访问权限控制
- 驱动程序安装可能被安全软件阻止

### 7.3 性能限制
- 抓包过程可能影响系统性能
- 大量数据包处理可能消耗较多内存
- AI分析响应时间可能较长
- Windows平台需要额外的驱动安装步骤

## 8. 未来扩展计划

### 8.1 真实抓包功能集成
为了在条件允许的环境中提供真实的抓包功能，我们计划：
1. 提供可选的真实抓包库集成（如node_pcap）
2. 实现条件编译，根据环境自动选择合适的抓包方案
3. 提供详细的安装指南，帮助用户解决原生依赖安装问题
4. 实现混合模式，支持模拟和真实抓包切换

### 8.2 高级功能扩展
1. 实现完整的数据包过滤功能（BPF语法支持）
2. 添加协议分析和可视化功能
3. 实现历史抓包记录管理和比较功能
4. 提供更丰富的AI分析模板和自定义选项

